<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Anonymous Customer Feedback</title>
<link rel="stylesheet" href="feedback.css">
<link rel="stylesheet" href="submit_feedback.php">
</head>
<body>

<button id="home-btn" onclick="window.location.href='index.html'">← Home</button>

<h1>From Our Happy Customers</h1>
<p class="description">
  We don't just promise great service – we deliver it. Share your experience with us below!
</p>

<section id="feedback-list">
</section>

<section id="form-section">
  <h2>Share Your Feedback</h2>
  
  <div id="alertContainer"></div>
  
  <form id="feedback-form">
    <label for="feedback-text">Your feedback</label>
    <textarea id="feedback-text" name="feedback-text" placeholder="Ilagay dito ang inyong feedback..." minlength="10" required></textarea>

    <label for="rating">Your rating</label>
    <select id="rating" name="rating" required>
      <option value="" disabled selected>Select rating</option>
      <option value="5">★★★★★ - Excellent</option>
      <option value="4">★★★★☆ - Very Good</option>
      <option value="3">★★★☆☆ - Good</option>
      <option value="2">★★☆☆☆ - Fair</option>
      <option value="1">★☆☆☆☆ - Poor</option>
    </select>

    <button type="submit" id="submit-btn">Submit Feedback</button>
  </form>
</section>

<script>
  const feedbackList = document.getElementById('feedback-list');
  const form = document.getElementById('feedback-form');
  const alertContainer = document.getElementById('alertContainer');
  const submitBtn = document.getElementById('submit-btn');

  // Load existing feedbacks from database
  function loadFeedbacks() {
    fetch('get_feedbacks.php')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          displayFeedbacks(data.feedbacks);
        } else {
          feedbackList.innerHTML = '<div class="loading">Unable to load feedbacks.</div>';
        }
      })
      .catch(error => {
        console.error('Error loading feedbacks:', error);
        feedbackList.innerHTML = '<div class="loading">Unable to load feedbacks.</div>';
      });
  }

  // Display feedbacks
  function displayFeedbacks(feedbacks) {
    if (feedbacks.length === 0) {
      feedbackList.innerHTML = '<div class="loading">No feedbacks yet. Be the first to share!</div>';
      return;
    }

    feedbackList.innerHTML = '';
    
    feedbacks.forEach(feedback => {
      const card = createFeedbackCard(feedback.comment, feedback.rating);
      feedbackList.appendChild(card);
    });
  }

  // Create feedback card element
  function createFeedbackCard(comment, rating) {
    const fullStar = '★';
    const emptyStar = '☆';
    const stars = fullStar.repeat(rating) + emptyStar.repeat(5 - rating);

    const card = document.createElement('div');
    card.classList.add('feedback-card');
    card.textContent = comment;

    const starsDiv = document.createElement('div');
    starsDiv.classList.add('stars');
    starsDiv.textContent = stars;

    card.appendChild(starsDiv);
    return card;
  }

  // Show alert message
  function showAlert(message, type) {
    alertContainer.innerHTML = `<div class="alert alert-${type} show">${message}</div>`;
    
    setTimeout(() => {
      const alert = alertContainer.querySelector('.alert');
      if (alert) {
        alert.classList.remove('show');
        setTimeout(() => {
          alertContainer.innerHTML = '';
        }, 300);
      }
    }, 5000);
  }

  // Handle form submission
  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const feedbackText = this['feedback-text'].value.trim();
    const rating = this['rating'].value;

    if (feedbackText.length < 10) {
      showAlert('Please provide more detailed feedback (at least 10 characters).', 'error');
      return;
    }

    if (!rating) {
      showAlert('Please select a rating.', 'error');
      return;
    }

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    // Submit to database
    const formData = new FormData();
    formData.append('comment', feedbackText);
    formData.append('rating', rating);

    try {
      const response = await fetch('submit_feedback.php', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        showAlert('Salamat sa inyong feedback! Your feedback has been submitted successfully.', 'success');
        
        // Add new feedback card to the top
        const newCard = createFeedbackCard(feedbackText, parseInt(rating));
        feedbackList.prepend(newCard);
        
        // Reset form
        this.reset();
        
        // Scroll to new card
        newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        showAlert('Error: ' + data.message, 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showAlert('Failed to submit feedback. Please try again.', 'error');
    } finally {
      // Re-enable submit button
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Feedback';
    }
  });

  // Load feedbacks on page load
  loadFeedbacks();
</script>

<footer>
  © 2025 Panyeros Kusina. All rights reserved.
</footer>

</body>
</html>